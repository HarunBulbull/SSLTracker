{% extends "base.html" %}
{% block title %}Domain listesi · SSLTracker{% endblock %}
{% block content %}
  <div class="flex flex-col gap-6">
    {% if error == 'domain_empty' %}
    <div class="rounded-lg border border-warn/50 bg-warn/10 px-4 py-2 text-warn text-sm">Domain boş olamaz.</div>
    {% elif error == 'domain_exists' %}
    <div class="rounded-lg border border-warn/50 bg-warn/10 px-4 py-2 text-warn text-sm">Bu domain zaten kayıtlı.</div>
    {% endif %}
    {% if certbot_error %}
    <div class="rounded-lg border border-danger/50 bg-danger/10 px-4 py-2 text-danger text-sm">
      <strong>Certbot hatası (sertifika üretilemedi):</strong><br>
      <span class="whitespace-pre-wrap">{{ certbot_error }}</span><br>
      <span class="text-gray-500 text-xs">Detay: sunucuda <code>certs/logs/letsencrypt.log</code> dosyasına bakın.</span>
    </div>
    {% endif %}
    {% if challenge_job and challenge_file_name and challenge_file_content and challenge_domain_id %}
    <div class="rounded-lg border border-accent/50 bg-accent/10 p-4">
      <h3 class="font-semibold text-accent mb-2">Doğrulama dosyasını yükleyin (domain başka sunucuda)</h3>
      <p class="text-sm text-gray-400 mb-2">
        <strong>{{ challenge_domain }}</strong> domain’inin yayınlandığı sunucuda aşağıdaki dosyayı oluşturun (FTP/SFTP veya hosting paneli ile). Sonra butona basın.
      </p>
      <div class="mb-2 text-sm">
        <span class="text-gray-500">Dosya yolu (sunucuda):</span>
        <code class="block mt-1 p-2 bg-panel rounded break-all">.well-known/acme-challenge/{{ challenge_file_name }}</code>
      </div>
      <div class="mb-4 text-sm">
        <span class="text-gray-500">Dosya içeriği (tam olarak bu metin olsun):</span>
        <code class="block mt-1 p-2 bg-panel rounded break-all">{{ challenge_file_content }}</code>
      </div>
      <form action="{{ url_for('refresh_challenge_continue', domain_id=challenge_domain_id) }}" method="post">
        <input type="hidden" name="challenge_job" value="{{ challenge_job }}">
        <button type="submit" class="px-4 py-2 bg-accent hover:bg-blue-600 rounded font-medium text-sm">
          Dosyayı yükledim, sertifika üretimini tamamla
        </button>
      </form>
    </div>
    {% endif %}
    <section class="flex flex-wrap items-end gap-4">
      <form action="{{ url_for('add_domain') }}" method="post" class="flex flex-wrap items-end gap-3">
        <div>
          <label for="domain" class="block text-sm text-gray-400 mb-1">Yeni domain</label>
          <input type="text" id="domain" name="domain" placeholder="example.com" required
                 class="bg-surface border border-gray-600 rounded px-3 py-2 w-64 focus:ring-2 focus:ring-accent focus:border-transparent outline-none"
                 autocomplete="off">
        </div>
        <button type="submit" class="px-4 py-2 bg-accent hover:bg-blue-600 rounded font-medium transition">
          Ekle
        </button>
      </form>
    </section>

    <section class="rounded-lg border border-gray-700/50 overflow-hidden bg-surface/50">
      <table class="w-full text-left">
        <thead class="bg-surface border-b border-gray-700">
          <tr>
            <th class="px-4 py-3 text-gray-400 font-medium">Domain</th>
            <th class="px-4 py-3 text-gray-400 font-medium">Durum</th>
            <th class="px-4 py-3 text-gray-400 font-medium">Bitiş</th>
            <th class="px-4 py-3 text-gray-400 font-medium">İşlemler</th>
            <th class="px-4 py-3 text-gray-400 font-medium">İndir</th>
          </tr>
        </thead>
        <tbody>
          {% for d in domains %}
          <tr class="border-b border-gray-700/50 hover:bg-gray-800/30 transition">
            <td class="px-4 py-3">
              <span class="font-medium">{{ d.domain }}</span>
            </td>
            <td class="px-4 py-3">
              {% if d.days_until_expiry is none %}
                <span class="status-unknown">—</span>
              {% elif d.days_until_expiry < 0 %}
                <span class="status-expired">Süresi doldu</span>
              {% elif d.days_until_expiry <= 7 %}
                <span class="status-critical">{{ d.days_until_expiry }} gün</span>
              {% elif d.days_until_expiry <= 30 %}
                <span class="status-warning">{{ d.days_until_expiry }} gün</span>
              {% else %}
                <span class="status-ok">{{ d.days_until_expiry }} gün</span>
              {% endif %}
              {% if d.last_error and not d.ssl_valid %}
                <span class="text-danger text-sm ml-1" title="{{ d.last_error }}">⚠</span>
              {% endif %}
            </td>
            <td class="px-4 py-3 text-gray-400 text-sm">
              {% if d.expires_at %}{{ d.expires_at.strftime('%Y-%m-%d %H:%M') }}{% else %}—{% endif %}
            </td>
            <td class="px-4 py-3 flex flex-wrap gap-2">
              <form action="{{ url_for('refresh_domain_ssl', domain_id=d.id) }}" method="post" class="inline">
                <button type="submit" class="text-sm text-accent hover:underline">Yenile</button>
              </form>
              <form action="{{ url_for('remove_domain', domain_id=d.id) }}" method="post" class="inline" onsubmit="return confirm('Bu domaini silmek istediğinize emin misiniz?');">
                <button type="submit" class="text-sm text-danger hover:underline">Sil</button>
              </form>
            </td>
            <td class="px-4 py-3">
              <div class="flex flex-wrap gap-2 text-sm">
                <a href="{{ url_for('download_cert', domain_id=d.id) }}" class="text-accent hover:underline">.crt</a>
                <a href="{{ url_for('download_fullchain', domain_id=d.id) }}" class="text-accent hover:underline">fullchain</a>
                <a href="{{ url_for('download_chain', domain_id=d.id) }}" class="text-accent hover:underline">cabundle</a>
                <a href="{{ url_for('download_key', domain_id=d.id) }}" class="text-accent hover:underline">.key</a>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5" class="px-4 py-8 text-center text-gray-500">Henüz domain eklenmedi. Yukarıdan ekleyin.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <p class="text-sm text-gray-500">
      <strong>Yenile</strong> sertifika doğrulaması için bir dosya bilgisi verir. Bu dosyayı domain’in yayınlandığı sunucuda <code>.well-known/acme-challenge/</code> altına yükleyip “tamamla” deyin; sertifikalar <code>certs/live/DOMAIN/</code> altında oluşur. <strong>İndir</strong>: .crt, cabundle, .key dosyalarını indirin.
    </p>
  </div>
{% endblock %}
